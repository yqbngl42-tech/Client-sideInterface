<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>רישומים חדשים - מערכת ניהול מוניות</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dark-mode.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>
          <i class="fas fa-taxi"></i>
          Taxi Manager
        </h2>
        <div class="user-info" id="userInfo">
          <i class="fas fa-user-circle"></i>
          מנהל מערכת
        </div>
      </div>

      <ul class="sidebar-menu">
        <li class="menu-section-title">ניהול</li>
        <a href="dashboard.html" class="menu-item">
          <i class="fas fa-home"></i>
          <span>לוח בקרה</span>
        </a>
        <a href="rides.html" class="menu-item">
          <i class="fas fa-car"></i>
          <span>נסיעות</span>
        </a>
        <a href="drivers.html" class="menu-item">
          <i class="fas fa-users"></i>
          <span>נהגים</span>
        </a>
        <a href="registrations.html" class="menu-item active">
          <i class="fas fa-user-plus"></i>
          <span>רישומים חדשים</span>
        </a>
        <a href="payments.html" class="menu-item">
          <i class="fas fa-money-bill-wave"></i>
          <span>תשלומים</span>
        </a>
        <a href="messages.html" class="menu-item">
          <i class="fas fa-envelope"></i>
          <span>הודעות</span>
        </a>
        <a href="reports.html" class="menu-item">
          <i class="fas fa-chart-bar"></i>
          <span>דוחות</span>
        </a>
        
        <li class="menu-section-title">מערכת</li>
        <a href="settings.html" class="menu-item">
          <i class="fas fa-cog"></i>
          <span>הגדרות</span>
        </a>
        <a href="#" class="menu-item" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>התנתק</span>
        </a>
      </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- HEADER -->
      <header class="header">
        <div class="header-title">
          <h1>
            <i class="fas fa-user-plus"></i>
            רישומים חדשים
          </h1>
        </div>
        <div class="header-actions">
          <button class="btn-icon" id="themeToggle" title="החלף ערכת נושא">
            <i class="fas fa-moon"></i>
          </button>
          <button class="btn-icon" title="רענן" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </header>

      <!-- CONTENT -->
      <div class="content-area">
        
        <!-- STATS -->
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-info">
              <h3>ממתינים לאישור</h3>
              <div class="stat-value" id="pendingCount">-</div>
            </div>
            <div class="stat-icon warning">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-info">
              <h3>אושרו היום</h3>
              <div class="stat-value" id="approvedToday">-</div>
            </div>
            <div class="stat-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-info">
              <h3>נדחו היום</h3>
              <div class="stat-value" id="rejectedToday">-</div>
            </div>
            <div class="stat-icon danger">
              <i class="fas fa-times-circle"></i>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-info">
              <h3>תקועים</h3>
              <div class="stat-value" id="stuckCount">-</div>
            </div>
            <div class="stat-icon primary">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>

        <!-- FILTERS -->
        <div class="card">
          <div class="card-header">
            <h2>
              <i class="fas fa-filter"></i>
              סינונים
            </h2>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div class="form-group">
                <label>סטטוס</label>
                <select id="filterStatus" class="form-control">
                  <option value="">הכל</option>
                  <option value="pending">ממתין</option>
                  <option value="approved">אושר</option>
                  <option value="rejected">נדחה</option>
                  <option value="stuck">תקוע</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>מיון</label>
                <select id="sortBy" class="form-control">
                  <option value="newest">החדשים ביותר</option>
                  <option value="oldest">הישנים ביותר</option>
                  <option value="name">לפי שם</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>חיפוש</label>
                <input type="text" id="searchQuery" class="form-control" placeholder="שם, טלפון...">
              </div>
            </div>
          </div>
        </div>

        <!-- REGISTRATIONS TABLE -->
        <div class="card">
          <div class="card-header">
            <h2>
              <i class="fas fa-list"></i>
              רשימת רישומים
              <span class="badge" id="registrationsCount">0</span>
            </h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>שם מלא</th>
                    <th>טלפון</th>
                    <th>ת.ז</th>
                    <th>רישיון</th>
                    <th>רכב</th>
                    <th>תאריך</th>
                    <th>סטטוס</th>
                    <th style="width: 200px;">פעולות</th>
                  </tr>
                </thead>
                <tbody id="registrationsTableBody">
                  <tr>
                    <td colspan="8" style="text-align: center; padding: 40px;">
                      <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary);"></i>
                      <p style="margin-top: 10px; color: var(--gray);">טוען רישומים...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- PAGINATION -->
            <div class="pagination-container" id="paginationContainer" style="display: none;">
              <div class="pagination-info">
                מציג <span id="showingFrom">1</span>-<span id="showingTo">10</span> מתוך <span id="totalItems">0</span>
              </div>
              <div class="pagination" id="pagination"></div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- SCRIPTS -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/shortcuts.js"></script>
  
  <script>
    // ===============================================
    // ➕ REGISTRATIONS PAGE LOGIC
    // ===============================================
    
    const RegistrationsPage = {
      currentPage: 1,
      pageSize: 25,
      totalPages: 0,
      registrations: [],
      filters: {},
      
      async init() {
        this.attachEventListeners();
        await this.loadRegistrations();
        await this.loadStats();
      },
      
      attachEventListeners() {
        // Refresh
        document.getElementById('refreshBtn')?.addEventListener('click', () => this.loadRegistrations());
        
        // Filters
        document.getElementById('filterStatus')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('sortBy')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('searchQuery')?.addEventListener('input', Utils.debounce(() => this.applyFilters(), 300));
        
        // Logout
        document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
          e.preventDefault();
          API.logout();
          window.location.href = 'index.html';
        });
      },
      
      async loadStats() {
        try {
          const registrations = await API.getRegistrations();
          
          const pending = registrations.filter(r => r.status === 'pending').length;
          
          const today = new Date().toISOString().split('T')[0];
          const approvedToday = registrations.filter(r => 
            r.status === 'approved' && r.updatedAt?.startsWith(today)
          ).length;
          const rejectedToday = registrations.filter(r => 
            r.status === 'rejected' && r.updatedAt?.startsWith(today)
          ).length;
          
          // Stuck = pending for > 24 hours
          const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
          const stuck = registrations.filter(r => 
            r.status === 'pending' && new Date(r.createdAt) < oneDayAgo
          ).length;
          
          document.getElementById('pendingCount').textContent = pending;
          document.getElementById('approvedToday').textContent = approvedToday;
          document.getElementById('rejectedToday').textContent = rejectedToday;
          document.getElementById('stuckCount').textContent = stuck;
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      },
      
      async loadRegistrations() {
        try {
          Utils.showLoading();
          
          const response = await API.getRegistrations(this.filters);
          this.registrations = response.registrations || response;
          
          this.renderTable();
          this.renderPagination();
          
          document.getElementById('registrationsCount').textContent = this.registrations.length;
        } catch (error) {
          Utils.showAlert('שגיאה בטעינת רישומים: ' + error.message, 'error');
        } finally {
          Utils.hideLoading();
        }
      },
      
      renderTable() {
        const tbody = document.getElementById('registrationsTableBody');
        const start = (this.currentPage - 1) * this.pageSize;
        const end = start + this.pageSize;
        const pageRegistrations = this.registrations.slice(start, end);
        
        if (pageRegistrations.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px;">
                <i class="fas fa-user-plus" style="font-size: 48px; color: var(--gray); opacity: 0.3;"></i>
                <p style="margin-top: 10px; color: var(--gray);">אין רישומים להצגה</p>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = pageRegistrations.map(reg => `
          <tr>
            <td>
              <strong>${reg.name || '-'}</strong>
            </td>
            <td>
              <a href="tel:${reg.phone}">${reg.phone || '-'}</a>
            </td>
            <td>${reg.idNumber || '-'}</td>
            <td>${reg.licenseNumber || '-'}</td>
            <td>${reg.vehicleNumber || '-'}</td>
            <td>
              ${Utils.formatDate(reg.createdAt)}
              <br>
              <small style="color: var(--gray);">${Utils.formatTime(reg.createdAt)}</small>
            </td>
            <td>${this.getStatusBadge(reg.status)}</td>
            <td>
              <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <button class="btn-icon btn-sm" onclick="RegistrationsPage.viewDetails('${reg._id}')" title="צפייה">
                  <i class="fas fa-eye"></i>
                </button>
                ${reg.status === 'pending' ? `
                  <button class="btn-icon btn-sm btn-success" onclick="RegistrationsPage.approve('${reg._id}')" title="אשר">
                    <i class="fas fa-check"></i>
                  </button>
                  <button class="btn-icon btn-sm btn-danger" onclick="RegistrationsPage.reject('${reg._id}')" title="דחה">
                    <i class="fas fa-times"></i>
                  </button>
                ` : ''}
                <button class="btn-icon btn-sm" onclick="RegistrationsPage.sendMessage('${reg._id}')" title="שלח הודעה">
                  <i class="fas fa-comment"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      },
      
      getStatusBadge(status) {
        const badges = {
          pending: '<span class="badge badge-warning">ממתין</span>',
          approved: '<span class="badge badge-success">אושר</span>',
          rejected: '<span class="badge badge-danger">נדחה</span>',
          stuck: '<span class="badge badge-primary">תקוע</span>'
        };
        return badges[status] || '<span class="badge">לא ידוע</span>';
      },
      
      renderPagination() {
        this.totalPages = Math.ceil(this.registrations.length / this.pageSize);
        const container = document.getElementById('paginationContainer');
        const pagination = document.getElementById('pagination');
        
        if (this.totalPages <= 1) {
          container.style.display = 'none';
          return;
        }
        
        container.style.display = 'flex';
        
        let html = '';
        
        html += `<button class="page-btn" ${this.currentPage === 1 ? 'disabled' : ''} onclick="RegistrationsPage.goToPage(${this.currentPage - 1})">
          <i class="fas fa-chevron-right"></i>
        </button>`;
        
        for (let i = 1; i <= this.totalPages; i++) {
          if (i === 1 || i === this.totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
            html += `<button class="page-btn ${i === this.currentPage ? 'active' : ''}" onclick="RegistrationsPage.goToPage(${i})">${i}</button>`;
          } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
            html += `<span class="page-dots">...</span>`;
          }
        }
        
        html += `<button class="page-btn" ${this.currentPage === this.totalPages ? 'disabled' : ''} onclick="RegistrationsPage.goToPage(${this.currentPage + 1})">
          <i class="fas fa-chevron-left"></i>
        </button>`;
        
        pagination.innerHTML = html;
        
        const start = (this.currentPage - 1) * this.pageSize + 1;
        const end = Math.min(this.currentPage * this.pageSize, this.registrations.length);
        document.getElementById('showingFrom').textContent = start;
        document.getElementById('showingTo').textContent = end;
        document.getElementById('totalItems').textContent = this.registrations.length;
      },
      
      goToPage(page) {
        this.currentPage = page;
        this.renderTable();
        this.renderPagination();
      },
      
      applyFilters() {
        this.filters = {
          status: document.getElementById('filterStatus').value,
          sort: document.getElementById('sortBy').value,
          search: document.getElementById('searchQuery').value
        };
        this.currentPage = 1;
        this.loadRegistrations();
      },
      
      viewDetails(id) {
        Utils.showAlert('פיצ'ר צפייה בפרטים יבוא בקרוב!', 'info');
      },
      
      async approve(id) {
        if (!confirm('האם אתה בטוח שברצונך לאשר רישום זה?')) return;
        
        try {
          await API.approveRegistration(id);
          Utils.showAlert('הרישום אושר בהצלחה והנהג נוצר במערכת', 'success');
          await this.loadRegistrations();
          await this.loadStats();
        } catch (error) {
          Utils.showAlert('שגיאה באישור: ' + error.message, 'error');
        }
      },
      
      async reject(id) {
        const reason = prompt('הזן סיבה לדחייה:');
        if (!reason) return;
        
        try {
          await API.rejectRegistration(id, reason);
          Utils.showAlert('הרישום נדחה', 'success');
          await this.loadRegistrations();
          await this.loadStats();
        } catch (error) {
          Utils.showAlert('שגיאה בדחייה: ' + error.message, 'error');
        }
      },
      
      sendMessage(id) {
        Utils.showAlert('פיצ'ר שליחת הודעה יבוא בקרוב!', 'info');
      }
    };
    
    // Init
    document.addEventListener('DOMContentLoaded', () => RegistrationsPage.init());
  </script>
</body>
</html>
