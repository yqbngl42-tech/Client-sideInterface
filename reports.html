<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>דוחות ואנליטיקה - מערכת ניהול מוניות</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dark-mode.css">
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-taxi"></i> Taxi Manager</h2>
        <div class="user-info" id="userInfo"><i class="fas fa-user-circle"></i> מנהל מערכת</div>
      </div>
      <ul class="sidebar-menu">
        <li class="menu-section-title">ניהול</li>
        <a href="dashboard.html" class="menu-item"><i class="fas fa-home"></i><span>לוח בקרה</span></a>
        <a href="rides.html" class="menu-item"><i class="fas fa-car"></i><span>נסיעות</span></a>
        <a href="drivers.html" class="menu-item"><i class="fas fa-users"></i><span>נהגים</span></a>
        <a href="registrations.html" class="menu-item"><i class="fas fa-user-plus"></i><span>רישומים חדשים</span></a>
        <a href="payments.html" class="menu-item"><i class="fas fa-money-bill-wave"></i><span>תשלומים</span></a>
        <a href="messages.html" class="menu-item"><i class="fas fa-envelope"></i><span>הודעות</span></a>
        <a href="reports.html" class="menu-item active"><i class="fas fa-chart-bar"></i><span>דוחות</span></a>
        <li class="menu-section-title">מערכת</li>
        <a href="settings.html" class="menu-item"><i class="fas fa-cog"></i><span>הגדרות</span></a>
        <a href="#" class="menu-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>התנתק</span></a>
      </ul>
    </aside>

    <main class="main-content">
      <header class="header">
        <div class="header-title">
          <h1><i class="fas fa-chart-bar"></i> דוחות ואנליטיקה</h1>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" id="exportReportBtn">
            <i class="fas fa-download"></i> ייצא דוח
          </button>
          <button class="btn-icon" id="themeToggle"><i class="fas fa-moon"></i></button>
          <button class="btn-icon" id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
        </div>
      </header>

      <div class="content-area">
        <!-- FILTERS -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-filter"></i> פרמטרי דוח</h2>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div class="form-group">
                <label>תקופה</label>
                <select class="form-control" id="reportPeriod">
                  <option value="today">היום</option>
                  <option value="week">השבוע</option>
                  <option value="month" selected>החודש</option>
                  <option value="quarter">רבעון</option>
                  <option value="year">השנה</option>
                  <option value="custom">מותאם אישית</option>
                </select>
              </div>
              <div class="form-group" id="dateFromGroup" style="display: none;">
                <label>מתאריך</label>
                <input type="date" class="form-control" id="dateFrom">
              </div>
              <div class="form-group" id="dateToGroup" style="display: none;">
                <label>עד תאריך</label>
                <input type="date" class="form-control" id="dateTo">
              </div>
              <div class="form-group">
                <label>סוג דוח</label>
                <select class="form-control" id="reportType">
                  <option value="overview">סקירה כללית</option>
                  <option value="rides">נסיעות</option>
                  <option value="payments">תשלומים</option>
                  <option value="drivers">נהגים</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary" id="generateReportBtn" style="margin-top: 10px;">
              <i class="fas fa-chart-line"></i> צור דוח
            </button>
          </div>
        </div>

        <!-- OVERVIEW STATS -->
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-info">
              <h3>סה"כ נסיעות</h3>
              <div class="stat-value" id="totalRides">-</div>
              <small id="ridesChange" style="color: var(--success);">+0%</small>
            </div>
            <div class="stat-icon primary"><i class="fas fa-car"></i></div>
          </div>
          <div class="stat-card">
            <div class="stat-info">
              <h3>הכנסות</h3>
              <div class="stat-value" id="totalRevenue">₪0</div>
              <small id="revenueChange" style="color: var(--success);">+0%</small>
            </div>
            <div class="stat-icon success"><i class="fas fa-shekel-sign"></i></div>
          </div>
          <div class="stat-card">
            <div class="stat-info">
              <h3>נהגים פעילים</h3>
              <div class="stat-value" id="activeDrivers">-</div>
              <small id="driversChange" style="color: var(--success);">+0%</small>
            </div>
            <div class="stat-icon info"><i class="fas fa-users"></i></div>
          </div>
          <div class="stat-card">
            <div class="stat-info">
              <h3>שביעות רצון</h3>
              <div class="stat-value" id="avgRating">-</div>
              <small>ממוצע דירוגים</small>
            </div>
            <div class="stat-icon warning"><i class="fas fa-star"></i></div>
          </div>
        </div>

        <!-- CHARTS -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-chart-line"></i> נסיעות לפי זמן</h2>
            </div>
            <div class="card-body">
              <canvas id="ridesChart" style="max-height: 300px;"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-chart-pie"></i> נסיעות לפי סטטוס</h2>
            </div>
            <div class="card-body">
              <canvas id="statusChart" style="max-height: 300px;"></canvas>
            </div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-chart-bar"></i> הכנסות לפי נהג (Top 10)</h2>
            </div>
            <div class="card-body">
              <canvas id="driversChart" style="max-height: 300px;"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-chart-area"></i> תשלומים לפי חודש</h2>
            </div>
            <div class="card-body">
              <canvas id="paymentsChart" style="max-height: 300px;"></canvas>
            </div>
          </div>
        </div>

        <!-- DETAILED TABLES -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-table"></i> פירוט מלא</h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="detailedTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody">
                  <tr>
                    <td colspan="10" style="text-align: center; padding: 40px;">
                      <p>בחר פרמטרים וצור דוח</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/shortcuts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script>
    const ReportsPage = {
      charts: {},
      
      async init() {
        this.attachEventListeners();
        await this.generateReport();
      },
      
      attachEventListeners() {
        document.getElementById('reportPeriod').addEventListener('change', (e) => {
          const custom = e.target.value === 'custom';
          document.getElementById('dateFromGroup').style.display = custom ? 'block' : 'none';
          document.getElementById('dateToGroup').style.display = custom ? 'block' : 'none';
        });
        
        document.getElementById('generateReportBtn').addEventListener('click', () => this.generateReport());
        document.getElementById('exportReportBtn').addEventListener('click', () => this.exportReport());
        document.getElementById('refreshBtn').addEventListener('click', () => this.generateReport());
        
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
          e.preventDefault();
          API.logout();
          window.location.href = 'index.html';
        });
      },
      
      async generateReport() {
        try {
          Utils.showLoading();
          
          const period = document.getElementById('reportPeriod').value;
          const type = document.getElementById('reportType').value;
          
          const data = await API.getReportData(period, type);
          
          this.updateStats(data.stats);
          this.updateCharts(data);
          this.updateTable(data, type);
          
        } catch (error) {
          Utils.showAlert('שגיאה ביצירת דוח: ' + error.message, 'error');
        } finally {
          Utils.hideLoading();
        }
      },
      
      updateStats(stats) {
        document.getElementById('totalRides').textContent = stats.totalRides || 0;
        document.getElementById('totalRevenue').textContent = '₪' + (stats.totalRevenue || 0).toLocaleString();
        document.getElementById('activeDrivers').textContent = stats.activeDrivers || 0;
        document.getElementById('avgRating').textContent = (stats.avgRating || 0).toFixed(1) + '⭐';
        
        document.getElementById('ridesChange').textContent = (stats.ridesChange >= 0 ? '+' : '') + stats.ridesChange + '%';
        document.getElementById('revenueChange').textContent = (stats.revenueChange >= 0 ? '+' : '') + stats.revenueChange + '%';
        document.getElementById('driversChange').textContent = (stats.driversChange >= 0 ? '+' : '') + stats.driversChange + '%';
      },
      
      updateCharts(data) {
        // Rides by Time
        if (this.charts.rides) this.charts.rides.destroy();
        this.charts.rides = new Chart(document.getElementById('ridesChart'), {
          type: 'line',
          data: {
            labels: data.ridesOverTime?.labels || [],
            datasets: [{
              label: 'נסיעות',
              data: data.ridesOverTime?.data || [],
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37, 99, 235, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
        
        // Status Distribution
        if (this.charts.status) this.charts.status.destroy();
        this.charts.status = new Chart(document.getElementById('statusChart'), {
          type: 'doughnut',
          data: {
            labels: data.statusDistribution?.labels || [],
            datasets: [{
              data: data.statusDistribution?.data || [],
              backgroundColor: ['#16a34a', '#2563eb', '#ea580c', '#dc2626', '#64748b']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
        
        // Top Drivers
        if (this.charts.drivers) this.charts.drivers.destroy();
        this.charts.drivers = new Chart(document.getElementById('driversChart'), {
          type: 'bar',
          data: {
            labels: data.topDrivers?.labels || [],
            datasets: [{
              label: 'הכנסות (₪)',
              data: data.topDrivers?.data || [],
              backgroundColor: '#16a34a'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { display: false } }
          }
        });
        
        // Payments by Month
        if (this.charts.payments) this.charts.payments.destroy();
        this.charts.payments = new Chart(document.getElementById('paymentsChart'), {
          type: 'line',
          data: {
            labels: data.paymentsOverTime?.labels || [],
            datasets: [{
              label: 'תשלומים (₪)',
              data: data.paymentsOverTime?.data || [],
              borderColor: '#16a34a',
              backgroundColor: 'rgba(22, 163, 74, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
      },
      
      updateTable(data, type) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        
        if (type === 'rides') {
          thead.innerHTML = `
            <tr>
              <th>מספר</th>
              <th>נוסע</th>
              <th>נהג</th>
              <th>יעד</th>
              <th>תאריך</th>
              <th>מחיר</th>
              <th>סטטוס</th>
            </tr>
          `;
          tbody.innerHTML = (data.details || []).map(r => `
            <tr>
              <td>${r.rideNumber}</td>
              <td>${r.passenger}</td>
              <td>${r.driverName}</td>
              <td>${r.destination}</td>
              <td>${Utils.formatDate(r.createdAt)}</td>
              <td>₪${r.price || 0}</td>
              <td>${Utils.getStatusBadge(r.status)}</td>
            </tr>
          `).join('');
        } else if (type === 'payments') {
          thead.innerHTML = `
            <tr>
              <th>מספר</th>
              <th>נהג</th>
              <th>סכום</th>
              <th>סוג</th>
              <th>תאריך</th>
              <th>סטטוס</th>
            </tr>
          `;
          tbody.innerHTML = (data.details || []).map(p => `
            <tr>
              <td>#${p.paymentNumber}</td>
              <td>${p.driverName}</td>
              <td>₪${p.amount}</td>
              <td>${p.type}</td>
              <td>${Utils.formatDate(p.date)}</td>
              <td>${Utils.getStatusBadge(p.status)}</td>
            </tr>
          `).join('');
        } else if (type === 'drivers') {
          thead.innerHTML = `
            <tr>
              <th>שם</th>
              <th>נסיעות</th>
              <th>הכנסות</th>
              <th>דירוג</th>
              <th>סטטוס</th>
            </tr>
          `;
          tbody.innerHTML = (data.details || []).map(d => `
            <tr>
              <td>${d.name}</td>
              <td>${d.totalRides}</td>
              <td>₪${d.totalRevenue}</td>
              <td>${d.rating}⭐</td>
              <td>${Utils.getStatusBadge(d.status)}</td>
            </tr>
          `).join('');
        }
      },
      
      exportReport() {
        try {
          const type = document.getElementById('reportType').value;
          const period = document.getElementById('reportPeriod').value;
          
          const table = document.getElementById('detailedTable');
          const wb = XLSX.utils.table_to_book(table);
          XLSX.writeFile(wb, `דוח_${type}_${period}_${new Date().toISOString().split('T')[0]}.xlsx`);
          
          Utils.showAlert('הדוח יוצא בהצלחה', 'success');
        } catch (error) {
          Utils.showAlert('שגיאה בייצוא: ' + error.message, 'error');
        }
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => ReportsPage.init());
  </script>
</body>
</html>
