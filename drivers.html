<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>× ×™×”×•×œ × ×”×’×™× - ××¢×¨×›×ª × ×™×”×•×œ ××•× ×™×•×ª</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dark-mode.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>
          <i class="fas fa-taxi"></i>
          Taxi Manager
        </h2>
        <div class="user-info" id="userInfo">
          <i class="fas fa-user-circle"></i>
          ×× ×”×œ ××¢×¨×›×ª
        </div>
      </div>

      <ul class="sidebar-menu">
        <li class="menu-section-title">× ×™×”×•×œ</li>
        <a href="dashboard.html" class="menu-item">
          <i class="fas fa-home"></i>
          <span>×œ×•×— ×‘×§×¨×”</span>
        </a>
        <a href="rides.html" class="menu-item">
          <i class="fas fa-car"></i>
          <span>× ×¡×™×¢×•×ª</span>
        </a>
        <a href="drivers.html" class="menu-item active">
          <i class="fas fa-users"></i>
          <span>× ×”×’×™×</span>
        </a>
        <a href="registrations.html" class="menu-item">
          <i class="fas fa-user-plus"></i>
          <span>×¨×™×©×•××™× ×—×“×©×™×</span>
        </a>
        <a href="payments.html" class="menu-item">
          <i class="fas fa-money-bill-wave"></i>
          <span>×ª×©×œ×•××™×</span>
        </a>
        
        <li class="menu-section-title">××¢×¨×›×ª</li>
        <a href="settings.html" class="menu-item">
          <i class="fas fa-cog"></i>
          <span>×”×’×“×¨×•×ª</span>
        </a>
        <a href="#" class="menu-item" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>×”×ª× ×ª×§</span>
        </a>
      </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- HEADER -->
      <header class="header">
        <div class="header-title">
          <h1>
            <i class="fas fa-users"></i>
            × ×™×”×•×œ × ×”×’×™×
          </h1>
        </div>
        <div class="header-actions">
          <button class="btn btn-success" id="addDriverBtn">
            <i class="fas fa-user-plus"></i>
            ×”×•×¡×£ × ×”×’
          </button>
          <button class="btn-icon" id="themeToggle" title="×”×—×œ×£ ×¢×¨×›×ª × ×•×©×">
            <i class="fas fa-moon"></i>
          </button>
          <button class="btn-icon" title="×¨×¢× ×Ÿ" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </header>

      <!-- CONTENT -->
      <div class="content-area">
        
        <!-- STATS -->
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-info">
              <h3>×¡×”"×› × ×”×’×™×</h3>
              <div class="stat-value" id="totalDrivers">-</div>
            </div>
            <div class="stat-icon primary">
              <i class="fas fa-users"></i>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-info">
              <h3>× ×”×’×™× ×¤×¢×™×œ×™×</h3>
              <div class="stat-value" id="activeDrivers">-</div>
            </div>
            <div class="stat-icon success">
              <i class="fas fa-user-check"></i>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-info">
              <h3>× ×”×’×™× ×—×¡×•××™×</h3>
              <div class="stat-value" id="blockedDrivers">-</div>
            </div>
            <div class="stat-icon danger">
              <i class="fas fa-user-lock"></i>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-info">
              <h3>× ×”×’×™× ×–××™× ×™×</h3>
              <div class="stat-value" id="availableDrivers">-</div>
            </div>
            <div class="stat-icon warning">
              <i class="fas fa-user-clock"></i>
            </div>
          </div>
        </div>

        <!-- FILTERS -->
        <div class="card">
          <div class="card-header">
            <h2>
              <i class="fas fa-filter"></i>
              ×¡×™× ×•× ×™× ×•×—×™×¤×•×©
            </h2>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div class="form-group">
                <label>×¡×˜×˜×•×¡</label>
                <select id="filterStatus" class="form-control">
                  <option value="">×”×›×œ</option>
                  <option value="active">×¤×¢×™×œ</option>
                  <option value="available">×–××™×Ÿ</option>
                  <option value="busy">×¢×¡×•×§</option>
                  <option value="offline">×œ× ××—×•×‘×¨</option>
                  <option value="blocked">×—×¡×•×</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>××–×•×¨ ×¢×‘×•×“×”</label>
                <select id="filterRegion" class="form-control">
                  <option value="">×”×›×œ</option>
                  <option value="north">×¦×¤×•×Ÿ</option>
                  <option value="center">××¨×›×–</option>
                  <option value="south">×“×¨×•×</option>
                  <option value="jerusalem">×™×¨×•×©×œ×™×</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>×“×™×¨×•×’</label>
                <select id="filterRating" class="form-control">
                  <option value="">×”×›×œ</option>
                  <option value="5">â­â­â­â­â­</option>
                  <option value="4">â­â­â­â­</option>
                  <option value="3">â­â­â­</option>
                  <option value="2">â­â­</option>
                  <option value="1">â­</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>×—×™×¤×•×©</label>
                <input type="text" id="searchQuery" class="form-control" placeholder="×©×, ×˜×œ×¤×•×Ÿ, ×ª.×–...">
              </div>
            </div>
          </div>
        </div>

        <!-- DRIVERS TABLE -->
        <div class="card">
          <div class="card-header">
            <h2>
              <i class="fas fa-list"></i>
              ×¨×©×™××ª × ×”×’×™×
              <span class="badge" id="driversCount">0</span>
            </h2>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-sm btn-secondary" id="exportBtn">
                <i class="fas fa-file-excel"></i>
                ×™×™×¦×
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 40px;">
                      <input type="checkbox" id="selectAll">
                    </th>
                    <th>×©×</th>
                    <th>×˜×œ×¤×•×Ÿ</th>
                    <th>××¡×¤×¨ ×¨×›×‘</th>
                    <th>××–×•×¨</th>
                    <th>×“×™×¨×•×’</th>
                    <th>× ×¡×™×¢×•×ª</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th style="width: 150px;">×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody id="driversTableBody">
                  <tr>
                    <td colspan="9" style="text-align: center; padding: 40px;">
                      <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary);"></i>
                      <p style="margin-top: 10px; color: var(--gray);">×˜×•×¢×Ÿ × ×”×’×™×...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- PAGINATION -->
            <div class="pagination-container" id="paginationContainer" style="display: none;">
              <div class="pagination-info">
                ××¦×™×’ <span id="showingFrom">1</span>-<span id="showingTo">10</span> ××ª×•×š <span id="totalItems">0</span>
              </div>
              <div class="pagination" id="pagination"></div>
              <div class="pagination-size">
                <select id="pageSize" class="form-control" style="width: auto;">
                  <option value="10">10</option>
                  <option value="25" selected>25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                ×œ×“×£
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- SCRIPTS -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/shortcuts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script>
    // ===============================================
    // ğŸ‘¥ DRIVERS PAGE LOGIC
    // ===============================================
    
    const DriversPage = {
      currentPage: 1,
      pageSize: 25,
      totalPages: 0,
      drivers: [],
      filters: {},
      
      async init() {
        this.attachEventListeners();
        await this.loadDrivers();
        await this.loadStats();
      },
      
      attachEventListeners() {
        // Add driver
        document.getElementById('addDriverBtn')?.addEventListener('click', () => this.openAddModal());
        
        // Refresh
        document.getElementById('refreshBtn')?.addEventListener('click', () => this.loadDrivers());
        
        // Filters
        document.getElementById('filterStatus')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('filterRegion')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('filterRating')?.addEventListener('change', () => this.applyFilters());
        document.getElementById('searchQuery')?.addEventListener('input', Utils.debounce(() => this.applyFilters(), 300));
        
        // Page size
        document.getElementById('pageSize')?.addEventListener('change', (e) => {
          this.pageSize = parseInt(e.target.value);
          this.currentPage = 1;
          this.loadDrivers();
        });
        
        // Export
        document.getElementById('exportBtn')?.addEventListener('click', () => this.exportDrivers());
        
        // Logout
        document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
          e.preventDefault();
          api.logout();
          window.location.href = 'index.html';
        });
      },
      
      async loadStats() {
        try {
          const drivers = await api.getDrivers();
          
          const total = drivers.length;
          const active = drivers.filter(d => d.status === 'active').length;
          const blocked = drivers.filter(d => d.status === 'blocked').length;
          const available = drivers.filter(d => d.status === 'available').length;
          
          document.getElementById('totalDrivers').textContent = total;
          document.getElementById('activeDrivers').textContent = active;
          document.getElementById('blockedDrivers').textContent = blocked;
          document.getElementById('availableDrivers').textContent = available;
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      },
      
      async loadDrivers() {
        try {
          Utils.showLoading();
          
          const response = await api.getDrivers(this.filters);
          this.drivers = response.drivers || response;
          
          this.renderTable();
          this.renderPagination();
          
          document.getElementById('driversCount').textContent = this.drivers.length;
        } catch (error) {
          Utils.showAlert('×©×’×™××” ×‘×˜×¢×™× ×ª × ×”×’×™×: ' + error.message, 'error');
        } finally {
          Utils.hideLoading();
        }
      },
      
      renderTable() {
        const tbody = document.getElementById('driversTableBody');
        const start = (this.currentPage - 1) * this.pageSize;
        const end = start + this.pageSize;
        const pageDrivers = this.drivers.slice(start, end);
        
        if (pageDrivers.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px;">
                <i class="fas fa-users" style="font-size: 48px; color: var(--gray); opacity: 0.3;"></i>
                <p style="margin-top: 10px; color: var(--gray);">××™×Ÿ × ×”×’×™× ×œ×”×¦×’×”</p>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = pageDrivers.map(driver => `
          <tr>
            <td>
              <input type="checkbox" class="driver-checkbox" data-id="${driver._id}">
            </td>
            <td>
              <strong>${driver.name}</strong>
              ${driver.driverId ? `<br><small style="color: var(--gray);">${driver.driverId}</small>` : ''}
            </td>
            <td>
              <a href="tel:${driver.phone}">${driver.phone}</a>
            </td>
            <td>${driver.vehicleNumber || '-'}</td>
            <td>${driver.workArea || '-'}</td>
            <td>
              ${this.renderRating(driver.rating?.average || 0)}
              <small style="color: var(--gray);">(${driver.rating?.count || 0})</small>
            </td>
            <td>${driver.statistics?.completedRides || 0}</td>
            <td>${Utils.getStatusBadge(driver.status || 'active')}</td>
            <td>
              <div style="display: flex; gap: 5px;">
                <button class="btn-icon btn-sm" onclick="DriversPage.viewDriver('${driver._id}')" title="×¦×¤×™×™×”">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-icon btn-sm" onclick="DriversPage.editDriver('${driver._id}')" title="×¢×¨×™×›×”">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-sm btn-danger" onclick="DriversPage.toggleBlock('${driver._id}', '${driver.status}')" title="${driver.status === 'blocked' ? '×‘×˜×œ ×—×¡×™××”' : '×—×¡×•×'}">
                  <i class="fas fa-${driver.status === 'blocked' ? 'unlock' : 'lock'}"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      },
      
      renderRating(rating) {
        const stars = Math.round(rating);
        let html = '';
        for (let i = 1; i <= 5; i++) {
          html += `<i class="fas fa-star" style="color: ${i <= stars ? '#fbbf24' : '#e5e7eb'};"></i>`;
        }
        return html;
      },
      
      renderPagination() {
        this.totalPages = Math.ceil(this.drivers.length / this.pageSize);
        const container = document.getElementById('paginationContainer');
        const pagination = document.getElementById('pagination');
        
        if (this.totalPages <= 1) {
          container.style.display = 'none';
          return;
        }
        
        container.style.display = 'flex';
        
        let html = '';
        
        // Previous
        html += `<button class="page-btn" ${this.currentPage === 1 ? 'disabled' : ''} onclick="DriversPage.goToPage(${this.currentPage - 1})">
          <i class="fas fa-chevron-right"></i>
        </button>`;
        
        // Pages
        for (let i = 1; i <= this.totalPages; i++) {
          if (i === 1 || i === this.totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
            html += `<button class="page-btn ${i === this.currentPage ? 'active' : ''}" onclick="DriversPage.goToPage(${i})">${i}</button>`;
          } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
            html += `<span class="page-dots">...</span>`;
          }
        }
        
        // Next
        html += `<button class="page-btn" ${this.currentPage === this.totalPages ? 'disabled' : ''} onclick="DriversPage.goToPage(${this.currentPage + 1})">
          <i class="fas fa-chevron-left"></i>
        </button>`;
        
        pagination.innerHTML = html;
        
        // Update info
        const start = (this.currentPage - 1) * this.pageSize + 1;
        const end = Math.min(this.currentPage * this.pageSize, this.drivers.length);
        document.getElementById('showingFrom').textContent = start;
        document.getElementById('showingTo').textContent = end;
        document.getElementById('totalItems').textContent = this.drivers.length;
      },
      
      goToPage(page) {
        this.currentPage = page;
        this.renderTable();
        this.renderPagination();
      },
      
      applyFilters() {
        this.filters = {
          status: document.getElementById('filterStatus').value,
          region: document.getElementById('filterRegion').value,
          rating: document.getElementById('filterRating').value,
          search: document.getElementById('searchQuery').value
        };
        this.currentPage = 1;
        this.loadDrivers();
      },
      
      openAddModal() {
        Utils.showAlert(`×¤×™×¦'×¨ ×”×•×¡×¤×ª × ×”×’ ×™×‘×•× ×‘×§×¨×•×‘!`, "info");
      },
      
      async viewDriver(id) {
        try {
          const driver = await api.getDriver(id);
          const html = `
            <div class="modal-overlay" onclick="this.remove()">
              <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px;">
                <div class="modal-header">
                  <h2><i class="fas fa-user"></i> ${driver.name}</h2>
                  <button class="btn-icon" onclick="this.closest('.modal-overlay').remove()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="tabs-mini">
                    <button class="tab-mini-btn active" data-tab="info">××™×“×¢</button>
                    <button class="tab-mini-btn" data-tab="notes">×”×¢×¨×•×ª (${driver.notes?.length || 0})</button>
                    <button class="tab-mini-btn" data-tab="history">×”×™×¡×˜×•×¨×™×”</button>
                    <button class="tab-mini-btn" data-tab="documents">××¡××›×™×</button>
                    <button class="tab-mini-btn" data-tab="stats">×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
                  </div>
                  
                  <div class="tab-mini-content active" data-content="info">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                      <div><strong>×˜×œ×¤×•×Ÿ:</strong> ${driver.phone}</div>
                      <div><strong>×ª.×–:</strong> ${driver.idNumber || '-'}</div>
                      <div><strong>×¨×™×©×™×•×Ÿ:</strong> ${driver.licenseNumber || '-'}</div>
                      <div><strong>×¨×›×‘:</strong> ${driver.vehicleNumber || '-'}</div>
                      <div><strong>××–×•×¨:</strong> ${driver.workArea || '-'}</div>
                      <div><strong>×¡×˜×˜×•×¡:</strong> ${Utils.getStatusBadge(driver.status)}</div>
                      <div><strong>×“×™×¨×•×’:</strong> ${this.renderRating(driver.rating?.average || 0)}</div>
                      <div><strong>× ×¡×™×¢×•×ª:</strong> ${driver.statistics?.completedRides || 0}</div>
                    </div>
                  </div>
                  
                  <div class="tab-mini-content" data-content="notes">
                    <div style="max-height: 300px; overflow-y: auto;">
                      ${(driver.notes || []).map(note => `
                        <div style="padding: 10px; background: var(--bg-secondary); border-radius: 5px; margin-bottom: 10px;">
                          <strong>${note.createdBy}</strong> - ${Utils.formatDate(note.createdAt)}
                          <p style="margin: 5px 0 0 0;">${note.text}</p>
                        </div>
                      `).join('') || '<p style="text-align: center; color: var(--gray);">××™×Ÿ ×”×¢×¨×•×ª</p>'}
                    </div>
                    <div style="margin-top: 15px;">
                      <textarea class="form-control" id="newNote" placeholder="×”×¢×¨×” ×—×“×©×”..." rows="2"></textarea>
                      <button class="btn btn-sm btn-primary" onclick="DriversPage.addNote('${id}')" style="margin-top: 10px;">
                        <i class="fas fa-plus"></i> ×”×•×¡×£ ×”×¢×¨×”
                      </button>
                    </div>
                  </div>
                  
                  <div class="tab-mini-content" data-content="history">
                    <div style="max-height: 300px; overflow-y: auto;">
                      ${(driver.statusHistory || []).map(h => `
                        <div style="padding: 10px; border-right: 3px solid var(--primary); margin-bottom: 10px;">
                          <strong>${Utils.formatDate(h.changedAt)}</strong><br>
                          ${h.from} â†’ ${h.to}<br>
                          <small style="color: var(--gray);">×¢×œ ×™×“×™: ${h.changedBy}</small>
                          ${h.reason ? `<br><small>×¡×™×‘×”: ${h.reason}</small>` : ''}
                        </div>
                      `).join('') || '<p style="text-align: center; color: var(--gray);">××™×Ÿ ×”×™×¡×˜×•×¨×™×”</p>'}
                    </div>
                  </div>
                  
                  <div class="tab-mini-content" data-content="documents">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                      ${(driver.documents || []).map(doc => `
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 5px;">
                          <h4 style="margin: 0 0 10px 0;">${doc.type}</h4>
                          <div style="display: flex; align-items: center; gap: 10px;">
                            ${doc.verified ? 
                              '<span class="badge badge-success"><i class="fas fa-check"></i> ×××•××ª</span>' : 
                              '<span class="badge badge-warning"><i class="fas fa-clock"></i> ×××ª×™×Ÿ</span>'}
                            <a href="${doc.url}" target="_blank" class="btn-icon btn-sm">
                              <i class="fas fa-download"></i>
                            </a>
                          </div>
                          <small style="color: var(--gray);">×ª×•×§×£: ${Utils.formatDate(doc.expiryDate)}</small>
                        </div>
                      `).join('') || '<p style="text-align: center; color: var(--gray);">××™×Ÿ ××¡××›×™×</p>'}
                    </div>
                    <button class="btn btn-sm btn-success" onclick="DriversPage.uploadDocument('${id}')" style="margin-top: 15px;">
                      <i class="fas fa-upload"></i> ×”×¢×œ×” ××¡××š
                    </button>
                  </div>
                  
                  <div class="tab-mini-content" data-content="stats">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                      <div class="stat-box">
                        <h4>× ×¡×™×¢×•×ª ×©×”×•×©×œ××•</h4>
                        <div class="stat-number">${driver.statistics?.completedRides || 0}</div>
                      </div>
                      <div class="stat-box">
                        <h4>××—×•×– ×”×¦×œ×—×”</h4>
                        <div class="stat-number">${driver.statistics?.successRate || 0}%</div>
                      </div>
                      <div class="stat-box">
                        <h4>×”×›× ×¡×•×ª ×›×•×œ×œ×•×ª</h4>
                        <div class="stat-number">â‚ª${(driver.statistics?.totalEarnings || 0).toLocaleString()}</div>
                      </div>
                      <div class="stat-box">
                        <h4>×××•×¦×¢ ×“×™×¨×•×’</h4>
                        <div class="stat-number">${(driver.rating?.average || 0).toFixed(1)}â­</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML('beforeend', html);
          
          // Attach tab switching
          document.querySelectorAll('.tab-mini-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              document.querySelectorAll('.tab-mini-btn').forEach(b => b.classList.remove('active'));
              document.querySelectorAll('.tab-mini-content').forEach(c => c.classList.remove('active'));
              this.classList.add('active');
              document.querySelector(`[data-content="${this.dataset.tab}"]`).classList.add('active');
            });
          });
        } catch (error) {
          Utils.showAlert('×©×’×™××”: ' + error.message, 'error');
        }
      },
      
      async addNote(driverId) {
        const text = document.getElementById('newNote').value;
        if (!text.trim()) return;
        
        try {
          await api.addDriverNote(driverId, text);
          Utils.showAlert('×”×¢×¨×” × ×•×¡×¤×”', 'success');
          document.querySelector('.modal-overlay').remove();
          await this.viewDriver(driverId);
        } catch (error) {
          Utils.showAlert('×©×’×™××”: ' + error.message, 'error');
        }
      },
      
      uploadDocument(driverId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,application/pdf';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          try {
            const formData = new FormData();
            formData.append('document', file);
            formData.append('type', prompt('×¡×•×’ ××¡××š (×¨×™×©×™×•×Ÿ/×‘×™×˜×•×—/×ª×¢×•×“×ª ×–×”×•×ª):') || 'other');
            
            await api.uploadDriverDocument(driverId, formData);
            Utils.showAlert('××¡××š ×”×•×¢×œ×” ×‘×”×¦×œ×—×”', 'success');
            document.querySelector('.modal-overlay').remove();
            await this.viewDriver(driverId);
          } catch (error) {
            Utils.showAlert('×©×’×™××” ×‘×”×¢×œ××”: ' + error.message, 'error');
          }
        };
        input.click();
      },
      
      editDriver(id) {
        Utils.showAlert(`×¤×™×¦'×¨ ×”×•×¡×¤×ª × ×”×’ ×™×‘×•× ×‘×§×¨×•×‘!`, "info");
      },
      
      async toggleBlock(id, currentStatus) {
        const newStatus = currentStatus === 'blocked' ? 'active' : 'blocked';
        const action = newStatus === 'blocked' ? '×œ×—×¡×•×' : '×œ×‘×˜×œ ×—×¡×™××”';
        
        if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ${action} × ×”×’ ×–×”?`)) return;
        
        try {
          await api.updateDriver(id, { status: newStatus });
          Utils.showAlert(`×”× ×”×’ ${newStatus === 'blocked' ? '× ×—×¡×' : '×©×•×—×¨×¨'} ×‘×”×¦×œ×—×”`, 'success');
          await this.loadDrivers();
          await this.loadStats();
        } catch (error) {
          Utils.showAlert('×©×’×™××”: ' + error.message, 'error');
        }
      },
      
      exportDrivers() {
        try {
          const data = this.drivers.map(d => ({
            '×©×': d.name,
            '×˜×œ×¤×•×Ÿ': d.phone,
            '××¡×¤×¨ ×¨×›×‘': d.vehicleNumber || '',
            '××–×•×¨': d.workArea || '',
            '×“×™×¨×•×’': d.rating?.average || 0,
            '× ×¡×™×¢×•×ª': d.statistics?.completedRides || 0,
            '×¡×˜×˜×•×¡': d.status || 'active'
          }));
          
          Utils.exportToExcel(data, '× ×”×’×™×_' + new Date().toISOString().split('T')[0]);
        } catch (error) {
          Utils.showAlert('×©×’×™××” ×‘×™×™×¦×•×: ' + error.message, 'error');
        }
      }
    };
    
    // Init
    document.addEventListener('DOMContentLoaded', () => DriversPage.init());
  </script>
  
  <style>
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s;
    }
    
    .modal-content {
      background: var(--bg-primary);
      border-radius: 12px;
      max-height: 90vh;
      overflow-y: auto;
      width: 90%;
      max-width: 600px;
      animation: slideUp 0.3s;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h2 {
      margin: 0;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .tabs-mini {
      display: flex;
      gap: 5px;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 20px;
    }
    
    .tab-mini-btn {
      padding: 10px 15px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-secondary);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .tab-mini-btn:hover {
      color: var(--primary);
    }
    
    .tab-mini-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .tab-mini-content {
      display: none;
    }
    
    .tab-mini-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    .stat-box {
      padding: 15px;
      background: var(--bg-secondary);
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-box h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</body>
<!-- ×”×“×‘×§ ××ª ×”×§×•×“ ×”×–×” ×œ×¤× ×™ </body> ×‘×§×•×‘×¥ drivers.html -->

<!-- ===============================================
     ğŸ¯ ADD DRIVER MODAL
     =============================================== -->
<div class="modal" id="addDriverModal" style="display: none;">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3><i class="fas fa-user-plus"></i> ×”×•×¡×¤×ª × ×”×’ ×—×“×©</h3>
      <button class="btn-icon" onclick="closeAddDriverModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form id="addDriverForm">
      <div class="form-row">
        <div class="form-group">
          <label>×©× ××œ× *</label>
          <input type="text" id="newDriverName" required placeholder="×™×•×¡×™ ×›×”×Ÿ">
        </div>
        
        <div class="form-group">
          <label>××¡×¤×¨ ×˜×œ×¤×•×Ÿ *</label>
          <input type="tel" id="newDriverPhone" required placeholder="0501234567" pattern="[0-9]{10}">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>××¡×¤×¨ ×¨×™×©×™×•×Ÿ × ×”×™×’×” *</label>
          <input type="text" id="newDriverLicense" required placeholder="1234567">
        </div>
        
        <div class="form-group">
          <label>××¡×¤×¨ ×¨×›×‘ *</label>
          <input type="text" id="newCarNumber" required placeholder="12-345-67">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>×“×’× ×¨×›×‘ *</label>
          <input type="text" id="newCarModel" required placeholder="×˜×•×™×•×˜×” ×§×•×¨×•×œ×” 2020">
        </div>
        
        <div class="form-group">
          <label>×©× ×ª ×™×™×¦×•×¨</label>
          <input type="number" id="newCarYear" placeholder="2020" min="1990" max="2025">
        </div>
      </div>
      
      <div class="form-group">
        <label>×”×¢×¨×•×ª</label>
        <textarea id="newDriverNotes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×¢×œ ×”× ×”×’..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="newDriverActive" checked>
          <span>× ×”×’ ×¤×¢×™×œ (×™×§×‘×œ × ×¡×™×¢×•×ª ××™×“)</span>
        </label>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeAddDriverModal()">
          ×‘×™×˜×•×œ
        </button>
        <button type="submit" class="btn btn-success">
          <i class="fas fa-check"></i> ×”×•×¡×£ × ×”×’
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .modal[style*="display: flex"] {
    display: flex !important;
  }
  
  .modal .modal-content {
    background: white;
    border-radius: 12px;
    padding: 30px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  
  .modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
  }
  
  .modal .modal-header h3 {
    font-size: 22px;
    color: var(--dark);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 8px;
  }
  
  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
  }
  
  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }
  
  .checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
  }
  
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 2px solid var(--border);
  }
  
  [data-theme="dark"] .modal .modal-content {
    background: #1e293b;
  }
  
  [data-theme="dark"] .modal .modal-header h3,
  [data-theme="dark"] .form-group label {
    color: #f1f5f9;
  }
  
  [data-theme="dark"] .form-group input,
  [data-theme="dark"] .form-group textarea {
    background: #0f172a;
    color: #f1f5f9;
    border-color: #334155;
  }
  
  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  function openAddDriverModal() {
    document.getElementById('addDriverModal').style.display = 'flex';
    document.getElementById('newDriverName').focus();
  }
  
  function closeAddDriverModal() {
    document.getElementById('addDriverModal').style.display = 'none';
    document.getElementById('addDriverForm').reset();
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addDriverForm');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const driverData = {
          name: document.getElementById('newDriverName').value,
          phone: document.getElementById('newDriverPhone').value,
          licenseNumber: document.getElementById('newDriverLicense').value,
          carNumber: document.getElementById('newCarNumber').value,
          carModel: document.getElementById('newCarModel').value,
          carYear: document.getElementById('newCarYear').value || null,
          notes: document.getElementById('newDriverNotes').value || '',
          status: document.getElementById('newDriverActive').checked ? 'active' : 'inactive'
        };
        
        try {
          const token = localStorage.getItem('taxi_admin_token');
          
          const response = await fetch('https://taxiserver-system.onrender.com/drivers', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(driverData)
          });
          
          if (!response.ok) throw new Error('Failed');
          
          alert('× ×”×’ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
          closeAddDriverModal();
          window.location.reload();
          
        } catch (error) {
          alert('×©×’×™××” ×‘×”×•×¡×¤×ª × ×”×’');
        }
      });
    }
    
    const addBtn = document.getElementById('addDriverBtn');
    if (addBtn) {
      addBtn.onclick = openAddDriverModal;
    }
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAddDriverModal();
  });
</script>
</body>
</html>