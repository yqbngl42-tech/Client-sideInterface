<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×”×’×“×¨×•×ª ××¢×¨×›×ª - ××¢×¨×›×ª × ×™×”×•×œ ××•× ×™×•×ª</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dark-mode.css">
  <link rel="stylesheet" href="css/help-button.css">
  <link rel="stylesheet" href="css/search-component.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>
          <i class="fas fa-taxi"></i>
          Taxi Manager
        </h2>
        <div class="user-info" id="userInfo">
          <i class="fas fa-user-circle"></i>
          ×× ×”×œ ××¢×¨×›×ª
        </div>
      </div>

      <ul class="sidebar-menu">
        <li class="menu-section-title">× ×™×”×•×œ</li>
        <a href="dashboard.html" class="menu-item">
          <i class="fas fa-home"></i>
          <span>×œ×•×— ×‘×§×¨×”</span>
        </a>
        <a href="rides.html" class="menu-item">
          <i class="fas fa-car"></i>
          <span>× ×¡×™×¢×•×ª</span>
        </a>
        <a href="drivers.html" class="menu-item">
          <i class="fas fa-users"></i>
          <span>× ×”×’×™×</span>
        </a>
        <a href="registrations.html" class="menu-item">
          <i class="fas fa-user-plus"></i>
          <span>×¨×™×©×•××™× ×—×“×©×™×</span>
        </a>
        <a href="payments.html" class="menu-item">
          <i class="fas fa-money-bill-wave"></i>
          <span>×ª×©×œ×•××™×</span>
        </a>
        <a href="messages.html" class="menu-item">
          <i class="fas fa-envelope"></i>
          <span>×”×•×“×¢×•×ª</span>
        </a>
        <a href="reports.html" class="menu-item">
          <i class="fas fa-chart-bar"></i>
          <span>×“×•×—×•×ª</span>
        </a>
        
        <li class="menu-section-title">××¢×¨×›×ª</li>
        <a href="system.html" class="menu-item">
          <i class="fas fa-cogs"></i>
          <span>× ×™×”×•×œ ××¢×¨×›×ª</span>
        </a>
        <a href="settings.html" class="menu-item">
          <i class="fas fa-cog"></i>
          <span>×”×’×“×¨×•×ª</span>
        </a>
        <a href="#" class="menu-item" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>×”×ª× ×ª×§</span>
        </a>
      </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- HEADER -->
      <header class="header">
        <div class="header-title">
          <h1>
            <i class="fas fa-cog"></i>
            ×”×’×“×¨×•×ª ××¢×¨×›×ª
          </h1>
        </div>
        <div class="header-actions">
          <button class="btn-icon" id="themeToggle" title="×”×—×œ×£ ×¢×¨×›×ª × ×•×©×">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </header>
      <!-- ğŸ†• SEARCH COMPONENT -->
      <div class="search-container">
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input 
            type="text" 
            id="globalSearch" 
            class="search-input"
            placeholder="×—×¤×© ×”×’×“×¨×ª ××¢×¨×›×ª, ×ª×™××•×¨ ××• ×§×˜×’×•×¨×™×”..."
            autocomplete="off">
          <button class="search-clear" id="clearSearch" style="display: none;">
            <i class="fas fa-times"></i>
          </button>
          <button class="search-advanced" id="advancedSearch">
            <i class="fas fa-sliders-h"></i> ×¡×™× ×•×Ÿ ××ª×§×“×
          </button>
        </div>
        
        <div class="advanced-filters" id="advancedFilters" style="display: none;">
          <div class="filter-row">
            <div class="filter-group">
              <label><i class="fas fa-filter"></i> ×§×˜×’×•×¨×™×”</label>
              <select id="filter_category" class="filter-select">
                <option value="">×”×›×œ</option>
                <option value="general">×›×œ×œ×™</option>
                <option value="security">××‘×˜×—×”</option>
                <option value="api">API</option>
                <option value="notifications">×”×ª×¨××•×ª</option>
                <option value="payments">×ª×©×œ×•××™×</option>
              </select>
            </div>

            <div class="filter-group">
              <label><i class="fas fa-filter"></i> ×¡×˜×˜×•×¡</label>
              <select id="filter_status" class="filter-select">
                <option value="">×”×›×œ</option>
                <option value="active">×¤×¢×™×œ</option>
                <option value="inactive">×œ× ×¤×¢×™×œ</option>
              </select>
            </div>
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
            <button class="btn btn-sm btn-secondary" onclick="SearchComponent.resetFilters()">
              <i class="fas fa-undo"></i> ××¤×¡ ×¡×™× ×•× ×™×
            </button>
            <button class="btn btn-sm btn-primary" onclick="SearchComponent.applyAdvancedFilters()">
              <i class="fas fa-check"></i> ×”×—×œ ×¡×™× ×•×Ÿ
            </button>
          </div>
        </div>
        
        <div class="search-results-info" id="searchInfo" style="display: none;">
          <span id="resultsCount">× ××¦××• 0 ×ª×•×¦××•×ª</span>
          <button class="btn-link" id="resetFilters">××¤×¡ ×—×™×¤×•×©</button>
        </div>
      </div>



      <!-- CONTENT -->
      <div class="content-area">
        
        <!-- TABS -->
        <div class="card">
          <div class="tabs">
            <button class="tab-btn active" data-tab="general">
              <i class="fas fa-sliders-h"></i>
              ×›×œ×œ×™
            </button>
            <button class="tab-btn" data-tab="pricing">
              <i class="fas fa-shekel-sign"></i>
              ×ª××—×•×¨
            </button>
            <button class="tab-btn" data-tab="notifications">
              <i class="fas fa-bell"></i>
              ×”×ª×¨××•×ª
            </button>
            <button class="tab-btn" data-tab="users">
              <i class="fas fa-users-cog"></i>
              ××©×ª××©×™×
            </button>
            <button class="tab-btn" data-tab="system">
              <i class="fas fa-server"></i>
              ××¢×¨×›×ª
            </button>
            <button class="tab-btn" data-tab="profile">
              <i class="fas fa-user"></i>
              ×¤×¨×•×¤×™×œ
            </button>
          </div>
        </div>

        <!-- TAB CONTENT: GENERAL -->
        <div class="tab-content active" id="tab-general">
          <div class="card">
            <div class="card-header">
              <h2>
                <i class="fas fa-sliders-h"></i>
                ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª
              </h2>
            </div>
            <div class="card-body">
              <form id="generalForm">
                <div class="form-group">
                  <label>×©× ×”××¢×¨×›×ª</label>
                  <input type="text" class="form-control" value="××¢×¨×›×ª × ×™×”×•×œ ××•× ×™×•×ª" id="systemName">
                </div>
                
                <div class="form-group">
                  <label>×˜×œ×¤×•×Ÿ ×œ×©×™×¨×•×ª ×œ×§×•×—×•×ª</label>
                  <input type="tel" class="form-control" placeholder="050-1234567" id="supportPhone">
                </div>
                
                <div class="form-group">
                  <label>××™××™×™×œ ×œ×ª××™×›×”</label>
                  <input type="email" class="form-control" placeholder="support@example.com" id="supportEmail">
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="autoDispatch">
                    ×©×™×‘×•×¥ ××•×˜×•××˜×™ ×œ× ×”×’×™×
                  </label>
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="enableRatings">
                    ××¤×©×¨ ×“×™×¨×•×’×™×
                  </label>
                </div>
                
                <div class="form-group">
                  <label>××¡×¤×¨ ××§×¡×™××œ×™ ×©×œ × ×”×’×™× ×œ× ×¡×™×¢×”</label>
                  <input type="number" class="form-control" value="5" id="maxDriversPerRide">
                </div>
                
                <div class="form-group">
                  <label>×–××Ÿ ×ª×¤×•×’×” ×œ× ×¡×™×¢×” (×“×§×•×ª)</label>
                  <input type="number" class="form-control" value="30" id="rideTimeout">
                </div>
                
                <div style="display: flex; gap: 10px;">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    ×©××•×¨ ×©×™× ×•×™×™×
                  </button>
                  <button type="button" class="btn btn-secondary" id="testConnectionBtn">
                    <i class="fas fa-plug"></i>
                    ×‘×“×•×§ ×—×™×‘×•×¨ ×œ×©×¨×ª
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- TAB CONTENT: PRICING -->
        <div class="tab-content" id="tab-pricing">
          <div class="card">
            <div class="card-header">
              <h2>
                <i class="fas fa-shekel-sign"></i>
                ×”×’×“×¨×•×ª ×ª××—×•×¨
              </h2>
            </div>
            <div class="card-body">
              <form id="pricingForm">
                <div class="form-group">
                  <label>××—×™×¨ ×—×•×“×©×™ ×œ×ª×—× ×” (â‚ª)</label>
                  <input type="number" class="form-control" value="500" id="stationMonthlyPrice">
                </div>
                
                <div class="form-group">
                  <label>××—×•×– ×¢××œ×” ×—×™×¦×•× ×™ (%)</label>
                  <input type="number" class="form-control" value="10" step="0.1" id="externalCommission">
                </div>
                
                <div class="form-group">
                  <label>××—×•×– ×¢××œ×” ×¤× ×™××™ (%)</label>
                  <input type="number" class="form-control" value="5" step="0.1" id="internalCommission">
                </div>
                
                <div class="form-group">
                  <label>××—×™×¨ ×‘×¡×™×¡ ×œ× ×¡×™×¢×” (â‚ª)</label>
                  <input type="number" class="form-control" value="25" id="baseRidePrice">
                </div>
                
                <div class="form-group">
                  <label>××—×™×¨ ×œ×§"× (â‚ª)</label>
                  <input type="number" class="form-control" value="5" step="0.1" id="pricePerKm">
                </div>
                
                <div class="form-group">
                  <label>××—×™×¨ ×œ×“×§×” (â‚ª)</label>
                  <input type="number" class="form-control" value="2" step="0.1" id="pricePerMinute">
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="enableSurge">
                    ××¤×©×¨ surge pricing (×ª××—×•×¨ ×“×™× ××™)
                  </label>
                </div>
                
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  ×©××•×¨ ×ª××—×•×¨
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- TAB CONTENT: NOTIFICATIONS -->
        <div class="tab-content" id="tab-notifications">
          <div class="card">
            <div class="card-header">
              <h2>
                <i class="fas fa-bell"></i>
                ×”×’×“×¨×•×ª ×”×ª×¨××•×ª
              </h2>
            </div>
            <div class="card-body">
              <form id="notificationsForm">
                <h3 style="margin-bottom: 20px;">WhatsApp</h3>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="notifyNewRide">
                    ×©×œ×— ×”×ª×¨××” ×¢×œ × ×¡×™×¢×” ×—×“×©×”
                  </label>
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="notifyRideCancelled">
                    ×©×œ×— ×”×ª×¨××” ×¢×œ ×‘×™×˜×•×œ × ×¡×™×¢×”
                  </label>
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="notifyPaymentDue">
                    ×©×œ×— ×”×ª×¨××” ×¢×œ ×ª×©×œ×•× ×©×××ª×™×Ÿ
                  </label>
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="notifyPaymentOverdue">
                    ×©×œ×— ×”×ª×¨××” ×¢×œ ×ª×©×œ×•× ×‘××™×—×•×¨
                  </label>
                </div>
                
                <hr>
                
                <h3 style="margin-bottom: 20px;">××™××™×™×œ</h3>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="emailDailyReport">
                    ×©×œ×— ×“×•×— ×™×•××™ ×‘××™××™×™×œ
                  </label>
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="emailWeeklyReport">
                    ×©×œ×— ×“×•×— ×©×‘×•×¢×™ ×‘××™××™×™×œ
                  </label>
                </div>
                
                <div class="form-group">
                  <label>×¨×©×™××ª ××™××™×™×œ×™× (××•×¤×¨×“×™× ×‘×¤×¡×™×§)</label>
                  <input type="text" class="form-control" placeholder="admin@example.com, manager@example.com" id="notificationEmails">
                </div>
                
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  ×©××•×¨ ×”×ª×¨××•×ª
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- TAB CONTENT: USERS -->
        <div class="tab-content" id="tab-users">
          <div class="card">
            <div class="card-header">
              <h2>
                <i class="fas fa-users-cog"></i>
                × ×™×”×•×œ ××©×ª××©×™×
              </h2>
              <button class="btn btn-success btn-sm" id="addUserBtn">
                <i class="fas fa-user-plus"></i>
                ×”×•×¡×£ ××©×ª××©
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>×©× ××©×ª××©</th>
                      <th>××™××™×™×œ</th>
                      <th>×ª×¤×§×™×“</th>
                      <th>×¡×˜×˜×•×¡</th>
                      <th>×”×ª×—×‘×¨×•×ª ××—×¨×•× ×”</th>
                      <th style="width: 100px;">×¤×¢×•×œ×•×ª</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody">
                    <tr>
                      <td colspan="6" style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary);"></i>
                        <p style="margin-top: 10px; color: var(--gray);">×˜×•×¢×Ÿ ××©×ª××©×™×...</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- TAB CONTENT: SYSTEM -->
        <div class="tab-content" id="tab-system">
          <div class="card">
            <div class="card-header">
              <h2>
                <i class="fas fa-server"></i>
                ××™×“×¢ ××¢×¨×›×ª
              </h2>
            </div>
            <div class="card-body">
              <div class="system-info">
                <div class="info-item">
                  <strong>×’×¨×¡×”:</strong>
                  <span id="systemVersion">4.0.0</span>
                </div>
                <div class="info-item">
                  <strong>×¡×˜×˜×•×¡ ×©×¨×ª:</strong>
                  <span class="badge badge-success" id="serverStatus">×¤×¢×™×œ</span>
                </div>
                <div class="info-item">
                  <strong>×¡×˜×˜×•×¡ MongoDB:</strong>
                  <span class="badge badge-success" id="dbStatus">××—×•×‘×¨</span>
                </div>
                <div class="info-item">
                  <strong>×¡×˜×˜×•×¡ WhatsApp Bot:</strong>
                  <span class="badge badge-success" id="botStatus">×¤×¢×™×œ</span>
                </div>
                <div class="info-item">
                  <strong>×–××Ÿ ×¤×¢×™×œ×•×ª:</strong>
                  <span id="uptime">-</span>
                </div>
                <div class="info-item">
                  <strong>×”×ª×§× ×”:</strong>
                  <span id="deployedAt">-</span>
                </div>
              </div>
              
              <hr style="margin: 30px 0;">
              
              <h3 style="margin-bottom: 20px;">×¤×¢×•×œ×•×ª ××¢×¨×›×ª</h3>
              
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="createBackupBtn">
                  <i class="fas fa-database"></i>
                  ×¦×•×¨ ×’×™×‘×•×™
                </button>
                
                <button class="btn btn-secondary" id="viewLogsBtn">
                  <i class="fas fa-file-alt"></i>
                  ×¦×¤×” ×‘×œ×•×’×™×
                </button>
                
                <button class="btn btn-secondary" id="clearCacheBtn">
                  <i class="fas fa-broom"></i>
                  × ×§×” Cache
                </button>
                
                <button class="btn btn-danger" id="restartServerBtn">
                  <i class="fas fa-sync-alt"></i>
                  ××ª×—×œ ×©×¨×ª
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- TAB CONTENT: PROFILE -->
        <div class="tab-content" id="tab-profile">
          <div class="card">
            <div class="card-header">
              <h2>
                <i class="fas fa-user"></i>
                ×¤×¨×•×¤×™×œ ××™×©×™
              </h2>
            </div>
            <div class="card-body">
              <form id="profileForm">
                <div class="form-group">
                  <label>×©× ××©×ª××©</label>
                  <input type="text" class="form-control" id="username" readonly>
                </div>
                
                <div class="form-group">
                  <label>××™××™×™×œ</label>
                  <input type="email" class="form-control" id="email">
                </div>
                
                <div class="form-group">
                  <label>×ª×¤×§×™×“</label>
                  <input type="text" class="form-control" id="role" readonly>
                </div>
                
                <hr>
                
                <h3 style="margin-bottom: 20px;">×©×™× ×•×™ ×¡×™×¡××”</h3>
                
                <div class="form-group">
                  <label>×¡×™×¡××” × ×•×›×—×™×ª</label>
                  <input type="password" class="form-control" id="currentPassword">
                </div>
                
                <div class="form-group">
                  <label>×¡×™×¡××” ×—×“×©×”</label>
                  <input type="password" class="form-control" id="newPassword">
                </div>
                
                <div class="form-group">
                  <label>××™××•×ª ×¡×™×¡××” ×—×“×©×”</label>
                  <input type="password" class="form-control" id="confirmPassword">
                </div>
                
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  ×©××•×¨ ×©×™× ×•×™×™×
                </button>
              </form>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- SCRIPTS -->
  <script src="js/config.js"></script>
  <script src="js/messages.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/shortcuts.js"></script>
  
  <script>
    // ===============================================
    // âš™ï¸ SETTINGS PAGE LOGIC
    // ===============================================
    
    const SettingsPage = {
      async init() {
        this.attachEventListeners();
        await this.loadGeneralSettings();
        await this.loadPricingSettings();
        await this.loadNotificationSettings();
        await this.loadSystemHealth();
        await this.loadUserProfile();
    this.initializeSearch();
      },
      
    
  initializeSearch() {
    SearchComponent.init({
      searchFields: ['name', 'description', 'category', 'key'],
      onSearch: (term, filters) => this.searchSettings(term, filters),
      highlightResults: false
    });
  },
  
  searchSettings(searchTerm, filters) {
    const categoryFilter = document.getElementById('filter_category')?.value || '';
    const statusFilter = document.getElementById('filter_status')?.value || '';
    
    this.filteredSettings = this.settings.filter(item => {
      const matchesSearch = SearchComponent.searchInFields(
        item,
        searchTerm,
        ['name', 'description', 'category', 'key']
      );
      
      const matchesCategory = !categoryFilter || item.category === categoryFilter;
      const matchesStatus = !statusFilter || item.status === statusFilter;
      
      return matchesSearch && matchesCategory && matchesStatus;
    });
    
    this.currentPage = 1;
    this.renderTable();
    this.renderPagination();
    
    return this.filteredSettings;
  },
  
  attachEventListeners() {
        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
        });
        
        // Forms
        document.getElementById('generalForm')?.addEventListener('submit', (e) => this.saveGeneral(e));
        document.getElementById('pricingForm')?.addEventListener('submit', (e) => this.savePricing(e));
        document.getElementById('notificationsForm')?.addEventListener('submit', (e) => this.saveNotifications(e));
        document.getElementById('profileForm')?.addEventListener('submit', (e) => this.saveProfile(e));
        
        // Test connection
        document.getElementById('testConnectionBtn')?.addEventListener('click', () => this.testConnection());
        
        // System actions
        document.getElementById('createBackupBtn')?.addEventListener('click', () => this.createBackup());
        document.getElementById('viewLogsBtn')?.addEventListener('click', () => this.viewLogs());
        document.getElementById('clearCacheBtn')?.addEventListener('click', () => this.clearCache());
        document.getElementById('restartServerBtn')?.addEventListener('click', () => this.restartServer());
        
        // Users
        document.getElementById('addUserBtn')?.addEventListener('click', () => this.addUser());
        
        // Logout
        document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
          e.preventDefault();
          API.logout();
          window.location.href = 'index.html';
        });
      },
      
      switchTab(tabName) {
        // Remove active from all
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active to selected
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
      },
      
      async loadSystemHealth() {
        try {
          const health = await API.getSystemHealth();
          
          document.getElementById('systemVersion').textContent = health.version || '4.0.0';
          document.getElementById('serverStatus').textContent = health.status === 'OK' ? '×¤×¢×™×œ' : '×œ× ×¤×¢×™×œ';
          document.getElementById('dbStatus').textContent = health.mongodb === 'Connected' ? '××—×•×‘×¨' : '×× ×•×ª×§';
          document.getElementById('botStatus').textContent = health.bot ? '×¤×¢×™×œ' : '×œ× ×¤×¢×™×œ';
          document.getElementById('uptime').textContent = this.formatUptime(health.uptime);
          document.getElementById('deployedAt').textContent = Utils.formatDate(health.deployedAt);
        } catch (error) {
          console.error('Error loading system health:', error);
        }
      },
      
      async loadUserProfile() {
        try {
          const user = await API.getCurrentUser();
          
          document.getElementById('username').value = user.username || '';
          document.getElementById('email').value = user.email || '';
          document.getElementById('role').value = this.getRoleName(user.role);
          
          document.getElementById('userInfo').innerHTML = `
            <i class="fas fa-user-circle"></i>
            ${user.username}
          `;
        } catch (error) {
          console.error('Error loading user profile:', error);
        }
      },
      
      getRoleName(role) {
        const roles = {
          admin: '×× ×”×œ ××¢×¨×›×ª',
          manager: '×× ×”×œ',
          viewer: '×¦×•×¤×”'
        };
        return roles[role] || role;
      },
      
      formatUptime(seconds) {
        if (!seconds) return '-';
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${days} ×™××™×, ${hours} ×©×¢×•×ª, ${minutes} ×“×§×•×ª`;
      },
      
      async loadGeneralSettings() {
        try {
          const response = await fetch(CONFIG.API_URL + '/api/settings/general', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('taxi_admin_token')}`
            }
          });
          const settings = await response.json();
          
          // Fill form
          document.getElementById('systemName').value = settings.companyName || '';
          document.getElementById('supportPhone').value = settings.companyPhone || '';
          document.getElementById('supportEmail').value = settings.companyEmail || '';
        } catch (error) {
          console.error('Error loading general settings:', error);
        }
      },
      
      async loadPricingSettings() {
        try {
          const response = await fetch(CONFIG.API_URL + '/api/settings/pricing', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('taxi_admin_token')}`
            }
          });
          const pricing = await response.json();
          
          // Fill form
          document.getElementById('baseRidePrice').value = pricing.basePrice || 25;
          document.getElementById('pricePerKm').value = pricing.pricePerKm || 5;
          document.getElementById('pricePerMinute').value = pricing.pricePerMinute || 2;
          document.getElementById('externalCommission').value = pricing.commissionPercent || 10;
        } catch (error) {
          console.error('Error loading pricing settings:', error);
        }
      },
      
      async loadNotificationSettings() {
        try {
          // Load from localStorage for now (server doesn't have this endpoint yet)
          const saved = localStorage.getItem('notification_settings');
          if (saved) {
            const settings = JSON.parse(saved);
            document.getElementById('notifyNewRide').checked = settings.notifyNewRide || false;
            document.getElementById('notifyRideCancelled').checked = settings.notifyRideCancelled || false;
            document.getElementById('notifyPaymentDue').checked = settings.notifyPaymentDue || false;
            document.getElementById('notifyPaymentOverdue').checked = settings.notifyPaymentOverdue || false;
            document.getElementById('emailDailyReport').checked = settings.emailDailyReport || false;
            document.getElementById('emailWeeklyReport').checked = settings.emailWeeklyReport || false;
            document.getElementById('notificationEmails').value = settings.notificationEmails || '';
          }
        } catch (error) {
          console.error('Error loading notification settings:', error);
        }
      },
      
      async saveGeneral(e) {
        e.preventDefault();
        
        try {
          Utils.showLoading('×©×•××¨ ×”×’×“×¨×•×ª...');
          
          const settings = {
            companyName: document.getElementById('systemName').value,
            companyPhone: document.getElementById('supportPhone').value,
            companyEmail: document.getElementById('supportEmail').value,
            autoDispatch: document.getElementById('autoDispatch').checked,
            enableRatings: document.getElementById('enableRatings').checked,
            maxDriversPerRide: parseInt(document.getElementById('maxDriversPerRide').value),
            rideTimeout: parseInt(document.getElementById('rideTimeout').value)
          };
          
          const response = await fetch(CONFIG.API_URL + '/api/settings/general', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('taxi_admin_token')}`
            },
            body: JSON.stringify(settings)
          });
          
          const result = await response.json();
          
          Utils.hideLoading();
          
          if (result.success) {
            Utils.showAlert(MESSAGES.SUCCESS_20, 'success');
          } else {
            throw new Error(result.error || '×©×’×™××” ×‘×©××™×¨×”');
          }
        } catch (error) {
          Utils.hideLoading();
          console.error('Error saving general settings:', error);
          Utils.showAlert(MESSAGES.ERROR_28 + error.message, 'error');
        }
      },
      
      async savePricing(e) {
        e.preventDefault();
        
        try {
          Utils.showLoading('×©×•××¨ ×ª××—×•×¨...');
          
          const pricing = {
            basePrice: parseFloat(document.getElementById('baseRidePrice').value),
            pricePerKm: parseFloat(document.getElementById('pricePerKm').value),
            pricePerMinute: parseFloat(document.getElementById('pricePerMinute').value),
            commissionPercent: parseFloat(document.getElementById('externalCommission').value),
            internalCommission: parseFloat(document.getElementById('internalCommission').value),
            enableSurge: document.getElementById('enableSurge').checked
          };
          
          const response = await fetch(CONFIG.API_URL + '/api/settings/pricing', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('taxi_admin_token')}`
            },
            body: JSON.stringify(pricing)
          });
          
          const result = await response.json();
          
          Utils.hideLoading();
          
          if (result.success) {
            Utils.showAlert(MESSAGES.SUCCESS_21, 'success');
          } else {
            throw new Error(result.error || '×©×’×™××” ×‘×©××™×¨×”');
          }
        } catch (error) {
          Utils.hideLoading();
          console.error('Error saving pricing settings:', error);
          Utils.showAlert(MESSAGES.ERROR_30 + error.message, 'error');
        }
      },
      
      async saveNotifications(e) {
        e.preventDefault();
        
        try {
          Utils.showLoading('×©×•××¨ ×”×ª×¨××•×ª...');
          
          const settings = {
            notifyNewRide: document.getElementById('notifyNewRide').checked,
            notifyRideCancelled: document.getElementById('notifyRideCancelled').checked,
            notifyPaymentDue: document.getElementById('notifyPaymentDue').checked,
            notifyPaymentOverdue: document.getElementById('notifyPaymentOverdue').checked,
            emailDailyReport: document.getElementById('emailDailyReport').checked,
            emailWeeklyReport: document.getElementById('emailWeeklyReport').checked,
            notificationEmails: document.getElementById('notificationEmails').value
          };
          
          // Save to localStorage (server endpoint doesn't exist yet)
          localStorage.setItem('notification_settings', JSON.stringify(settings));
          
          Utils.hideLoading();
          Utils.showAlert(MESSAGES.SUCCESS_19, 'success');
        } catch (error) {
          Utils.hideLoading();
          console.error('Error saving notification settings:', error);
          Utils.showAlert(MESSAGES.ERROR_29 + error.message, 'error');
        }
      },
      
      async testConnection() {
        try {
          Utils.showLoading('×‘×•×“×§ ×—×™×‘×•×¨...');
          
          const response = await fetch(CONFIG.API_URL + '/api/settings/general', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('taxi_admin_token')}`
            }
          });
          
          Utils.hideLoading();
          
          if (response.ok) {
            Utils.showAlert(MESSAGES.SUCCESS_22, 'success');
          } else {
            Utils.showAlert(MESSAGES.ERROR_24 + response.status, 'warning');
          }
        } catch (error) {
          Utils.hideLoading();
          Utils.showAlert(MESSAGES.ERROR_31 + error.message, 'error');
        }
      },
      
      async saveProfile(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword && newPassword !== confirmPassword) {
          Utils.showAlert(MESSAGES.MSG_4, 'error');
          return;
        }
        
        if (newPassword) {
          try {
            await API.changePassword(currentPassword, newPassword);
            Utils.showAlert(MESSAGES.SUCCESS_10, 'success');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
          } catch (error) {
            Utils.showAlert(MESSAGES.ERROR_20 + error.message, 'error');
          }
        } else {
          Utils.showAlert(MESSAGES.SUCCESS_18, 'success');
        }
      },
      
      async createBackup() {
        if (!confirm(MESSAGES.CONFIRM_4)) return;
        
        try {
          await API.createBackup();
          Utils.showAlert(MESSAGES.SUCCESS_3, 'success');
        } catch (error) {
          Utils.showAlert(MESSAGES.ERROR_18 + error.message, 'error');
        }
      },
      
      viewLogs() {
        Utils.showAlert(`×¤×™×¦'×¨ ×”×•×¡×¤×ª × ×”×’ ×™×‘×•× ×‘×§×¨×•×‘!`, "info");
      },
      
      async clearCache() {
        if (!confirm(MESSAGES.CONFIRM_5)) return;
        Utils.showAlert(MESSAGES.SUCCESS_1, 'success');
      },
      
      async restartServer() {
        if (!confirm(MESSAGES.CONFIRM_2)) return;
        Utils.showAlert(MESSAGES.MSG_30, 'info');
      },
      
      addUser() {
         Utils.showAlert(`×¤×™×¦'×¨ ×”×•×¡×¤×ª × ×”×’ ×™×‘×•× ×‘×§×¨×•×‘!`, "info");
      }
    };
    
    // Init
    document.addEventListener('DOMContentLoaded', () => SettingsPage.init());
  </script>
  
  <style>
    .tabs {
      display: flex;
      gap: 5px;
      border-bottom: 2px solid var(--border-color);
      padding: 0 20px;
      background: var(--bg-secondary);
    }
    
    .tab-btn {
      padding: 15px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab-btn:hover {
      color: var(--primary);
      background: var(--bg-primary);
    }
    
    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .system-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .info-item {
      padding: 15px;
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <!-- Help System -->
  <script src="js/help-button.js"></script>
  <script src="js/search-component.js"></script>
</body>
</html>