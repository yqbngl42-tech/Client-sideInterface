<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>לוח בקרה - מערכת ניהול מוניות</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dark-mode.css">
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-taxi"></i> Taxi Manager</h2>
        <div class="user-info" id="userInfo"><i class="fas fa-user-circle"></i> מנהל מערכת</div>
      </div>
      <ul class="sidebar-menu">
        <li class="menu-section-title">ניהול</li>
        <a href="dashboard.html" class="menu-item active"><i class="fas fa-home"></i><span>לוח בקרה</span></a>
        <a href="rides.html" class="menu-item"><i class="fas fa-car"></i><span>נסיעות</span></a>
        <a href="drivers.html" class="menu-item"><i class="fas fa-users"></i><span>נהגים</span></a>
        <a href="registrations.html" class="menu-item"><i class="fas fa-user-plus"></i><span>רישומים חדשים</span></a>
        <a href="payments.html" class="menu-item"><i class="fas fa-money-bill-wave"></i><span>תשלומים</span></a>
        <a href="messages.html" class="menu-item"><i class="fas fa-envelope"></i><span>הודעות</span></a>
        <a href="reports.html" class="menu-item"><i class="fas fa-chart-bar"></i><span>דוחות</span></a>
        <li class="menu-section-title">מערכת</li>
        <a href="settings.html" class="menu-item"><i class="fas fa-cog"></i><span>הגדרות</span></a>
        <a href="#" class="menu-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>התנתק</span></a>
      </ul>
    </aside>

    <main class="main-content">
      <header class="header">
        <div class="header-title">
          <h1><i class="fas fa-home"></i> לוח בקרה</h1>
        </div>
        <div class="header-actions">
          <button class="btn-icon" id="auditLogsBtn" title="Audit Logs">
            <i class="fas fa-history"></i>
          </button>
          <button class="btn-icon" id="themeToggle" title="החלף ערכת נושא">
            <i class="fas fa-moon"></i>
          </button>
          <button class="btn-icon" title="רענן" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </header>

      <div class="content-area">
        <!-- BIG CREATE RIDE BUTTON -->
        <div class="hero-action-card">
          <div class="hero-content">
            <h2><i class="fas fa-plus-circle"></i> צור נסיעה חדשה</h2>
            <p>הוסף נסיעה למערכת ושלח אותה לנהגים זמינים</p>
          </div>
          <button class="btn btn-hero" id="createRideHeroBtn">
            <i class="fas fa-taxi"></i>
            <span>נסיעה חדשה</span>
            <i class="fas fa-arrow-left"></i>
          </button>
        </div>

        <!-- STATS CARDS -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-info">
              <h3>נסיעות היום</h3>
              <div class="stat-value" id="todayRides">-</div>
            </div>
            <div class="stat-icon primary">
              <i class="fas fa-car"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>נהגים פעילים</h3>
              <div class="stat-value" id="activeDrivers">-</div>
            </div>
            <div class="stat-icon success">
              <i class="fas fa-users"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>רישומים ממתינים</h3>
              <div class="stat-value" id="pendingRegistrations">-</div>
            </div>
            <div class="stat-icon warning">
              <i class="fas fa-user-plus"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>תשלומים שלא שולמו</h3>
              <div class="stat-value" id="unpaidPayments">-</div>
            </div>
            <div class="stat-icon danger">
              <i class="fas fa-money-bill-wave"></i>
            </div>
          </div>
        </div>

        <!-- CHARTS -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-chart-line"></i> נסיעות לפי שעות</h2>
            </div>
            <div class="card-body">
              <canvas id="ridesChart" style="max-height: 250px;"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-chart-pie"></i> נסיעות לפי סטטוס</h2>
            </div>
            <div class="card-body">
              <canvas id="statusChart" style="max-height: 250px;"></canvas>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-bar"></i> נהגים פעילים (Top 10)</h2>
          </div>
          <div class="card-body">
            <canvas id="driversChart" style="max-height: 300px;"></canvas>
          </div>
        </div>

        <!-- RECENT RIDES -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-clock"></i> נסיעות אחרונות</h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>מספר</th>
                    <th>נוסע</th>
                    <th>יעד</th>
                    <th>זמן</th>
                    <th>סטטוס</th>
                  </tr>
                </thead>
                <tbody id="recentRidesTable">
                  <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                      <i class="fas fa-spinner fa-spin"></i> טוען...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ACTIVE DRIVERS -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-users"></i> נהגים פעילים</h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>שם</th>
                    <th>טלפון</th>
                    <th>סטטוס</th>
                    <th>נסיעות היום</th>
                  </tr>
                </thead>
                <tbody id="activeDriversTable">
                  <tr>
                    <td colspan="4" style="text-align: center; padding: 20px;">
                      <i class="fas fa-spinner fa-spin"></i> טוען...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/shortcuts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <script>
    const DashboardPage = {
      charts: {},
      refreshInterval: null,
      
      async init() {
        this.attachEventListeners();
        await this.loadData();
        this.startAutoRefresh();
      },
      
      attachEventListeners() {
        document.getElementById('refreshBtn')?.addEventListener('click', () => this.loadData());
        document.getElementById('auditLogsBtn')?.addEventListener('click', () => this.showAuditLogs());
        document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
          e.preventDefault();
          API.logout();
          window.location.href = 'index.html';
        });
      },
      
      async loadData() {
        try {
          await Promise.all([
            this.loadStats(),
            this.loadRecentRides(),
            this.loadActiveDrivers(),
            this.loadCharts()
          ]);
        } catch (error) {
          console.error('Error loading dashboard:', error);
        }
      },
      
      async loadStats() {
        try {
          const stats = await API.getDashboardStats();
          document.getElementById('todayRides').textContent = stats.todayRides || 0;
          document.getElementById('activeDrivers').textContent = stats.activeDrivers || 0;
          document.getElementById('pendingRegistrations').textContent = stats.pendingRegistrations || 0;
          document.getElementById('unpaidPayments').textContent = stats.unpaidPayments || 0;
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      },
      
      async loadRecentRides() {
        try {
          const rides = await API.getRecentRides(10);
          const tbody = document.getElementById('recentRidesTable');
          
          if (rides.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">אין נסיעות</td></tr>';
            return;
          }
          
          tbody.innerHTML = rides.map(ride => `
            <tr>
              <td><strong>#${ride.rideNumber || ride._id.slice(-6)}</strong></td>
              <td>${ride.passenger?.name || '-'}</td>
              <td>${ride.destination || '-'}</td>
              <td>${Utils.formatTime(ride.createdAt)}</td>
              <td>${Utils.getStatusBadge(ride.status)}</td>
            </tr>
          `).join('');
        } catch (error) {
          console.error('Error loading recent rides:', error);
        }
      },
      
      async loadActiveDrivers() {
        try {
          const drivers = await API.getActiveDrivers();
          const tbody = document.getElementById('activeDriversTable');
          
          if (drivers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">אין נהגים פעילים</td></tr>';
            return;
          }
          
          tbody.innerHTML = drivers.map(driver => `
            <tr>
              <td>${driver.name}</td>
              <td>${driver.phone}</td>
              <td>${Utils.getStatusBadge(driver.status)}</td>
              <td>${driver.todayRides || 0}</td>
            </tr>
          `).join('');
        } catch (error) {
          console.error('Error loading active drivers:', error);
        }
      },
      
      async loadCharts() {
        try {
          const data = await API.getDashboardCharts();
          
          // Rides by Hour
          if (this.charts.rides) this.charts.rides.destroy();
          this.charts.rides = new Chart(document.getElementById('ridesChart'), {
            type: 'line',
            data: {
              labels: data.ridesByHour?.labels || ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
              datasets: [{
                label: 'נסיעות',
                data: data.ridesByHour?.data || [5, 3, 12, 28, 35, 22],
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
          
          // Status Distribution
          if (this.charts.status) this.charts.status.destroy();
          this.charts.status = new Chart(document.getElementById('statusChart'), {
            type: 'doughnut',
            data: {
              labels: data.statusDistribution?.labels || ['הסתיים', 'בדרך', 'ממתין', 'בוטל'],
              datasets: [{
                data: data.statusDistribution?.data || [45, 12, 8, 3],
                backgroundColor: ['#16a34a', '#2563eb', '#ea580c', '#dc2626']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
          
          // Top Drivers
          if (this.charts.drivers) this.charts.drivers.destroy();
          this.charts.drivers = new Chart(document.getElementById('driversChart'), {
            type: 'bar',
            data: {
              labels: data.topDrivers?.labels || ['ישראל', 'משה', 'דוד', 'יוסי', 'אברהם'],
              datasets: [{
                label: 'נסיעות',
                data: data.topDrivers?.data || [28, 24, 21, 19, 17],
                backgroundColor: '#16a34a'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        } catch (error) {
          console.error('Error loading charts:', error);
        }
      },
      
      startAutoRefresh() {
        this.refreshInterval = setInterval(() => {
          this.loadData();
        }, 30000); // 30 seconds
      },
      
      async showAuditLogs() {
        try {
          const logs = await API.getAuditLogs({ limit: 50 });
          const html = `
            <div class="modal-overlay" onclick="this.remove()">
              <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 1000px;">
                <div class="modal-header">
                  <h2><i class="fas fa-history"></i> Audit Logs</h2>
                  <button class="btn-icon" onclick="this.closest('.modal-overlay').remove()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="modal-body">
                  <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <input type="text" class="form-control" placeholder="חיפוש..." id="auditSearch" style="flex: 1;">
                    <select class="form-control" id="auditAction" style="width: 200px;">
                      <option value="">כל הפעולות</option>
                      <option value="login">התחברות</option>
                      <option value="create">יצירה</option>
                      <option value="update">עדכון</option>
                      <option value="delete">מחיקה</option>
                    </select>
                  </div>
                  <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table">
                      <thead style="position: sticky; top: 0; background: var(--bg-primary); z-index: 1;">
                        <tr>
                          <th>זמן</th>
                          <th>משתמש</th>
                          <th>פעולה</th>
                          <th>פרטים</th>
                          <th>IP</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${logs.map(log => `
                          <tr>
                            <td style="white-space: nowrap;">${Utils.formatTime(log.timestamp)}</td>
                            <td>${log.username || '-'}</td>
                            <td><span class="badge">${log.action}</span></td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                              ${log.details ? JSON.stringify(log.details).substring(0, 100) : '-'}
                            </td>
                            <td><small>${log.ipAddress || '-'}</small></td>
                          </tr>
                        `).join('') || '<tr><td colspan="5" style="text-align: center;">אין לוגים</td></tr>'}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML('beforeend', html);
        } catch (error) {
          Utils.showAlert('שגיאה בטעינת לוגים: ' + error.message, 'error');
        }
      }
    };
    
    // Hero create ride button
    document.addEventListener('DOMContentLoaded', () => {
      DashboardPage.init();
      
      document.getElementById('createRideHeroBtn')?.addEventListener('click', () => {
        window.location.href = 'rides.html?create=true';
      });
    });
  </script>
  
  <style>
    /* ========================================
       HERO ACTION CARD
       ======================================== */
    .hero-action-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: var(--radius-lg);
      padding: 40px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-xl);
      color: white;
      position: relative;
      overflow: hidden;
      animation: slideIn 0.6s ease;
    }
    
    .hero-action-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }
    
    .hero-content {
      position: relative;
      z-index: 1;
    }
    
    .hero-content h2 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .hero-content p {
      font-size: 16px;
      opacity: 0.95;
    }
    
    .btn-hero {
      background: white;
      color: var(--primary);
      padding: 18px 40px;
      font-size: 20px;
      font-weight: 700;
      border: none;
      border-radius: var(--radius-lg);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all var(--transition);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      position: relative;
      z-index: 1;
    }
    
    .btn-hero:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 12px 30px rgba(0,0,0,0.3);
    }
    
    .btn-hero i:first-child {
      font-size: 28px;
    }
    
    .btn-hero i:last-child {
      transition: transform var(--transition);
    }
    
    .btn-hero:hover i:last-child {
      transform: translateX(-5px);
    }
    
    @media (max-width: 768px) {
      .hero-action-card {
        flex-direction: column;
        text-align: center;
        padding: 30px 20px;
      }
      
      .hero-content h2 {
        font-size: 24px;
        justify-content: center;
      }
      
      .hero-content p {
        font-size: 14px;
      }
      
      .btn-hero {
        margin-top: 20px;
        width: 100%;
        justify-content: center;
      }
    }
  </style>
  
  <style>
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s;
    }
    
    .modal-content {
      background: var(--bg-primary);
      border-radius: 12px;
      max-height: 90vh;
      overflow-y: auto;
      width: 90%;
      animation: slideUp 0.3s;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h2 {
      margin: 0;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</body>
</html>